# DNS 数据包结构

## DNS 通信概述

DNS（Domain Name System，域名系统）是一个基于 UDP（默认）或 TCP 的应用层协议，主要用于将域名解析为 IP 地址，以及反向解析 IP 地址到域名。

* UDP 端口：53 - 常规查询使用 UDP
* TCP 端口：53 - 当查询结果超过 512 字节，或者进行区域传输（Zone Transfer）时，使用 TCP

## DNS 数据包结构

DNS 数据包主要分为四个部分：

| 部分名称 | 描述 |
|----------|------|
| Header | 包含 ID、标志位、问题数、回答数、权威信息数、附加信息数 |
| Question | DNS 请求的域名、查询类型和查询类别 |
| Answer | 服务器返回的解析结果，包括 IP 地址或别名 |
| Authority | 权威域名服务器的相关信息 |
| Additional | 附加记录，比如 MX 或 CNAME 信息 |


## Header 部分

Header 是固定的 12 字节，用于标识查询的基本信息。

| 偏移量 | 字节 | 描述 |
|--------|------|------|
| 0x00 | 2 | Transaction ID：随机生成的请求 ID |
| 0x02 | 2 | Flags：标志位，包含查询/响应、是否递归等 |
| 0x04 | 2 | Questions：查询问题的数量 |
| 0x06 | 2 | Answer RRs：回答的数量 |
| 0x08 | 2 | Authority RRs：权威信息的数量 |
| 0x0A | 2 | Additional RRs：附加信息的数量 |


### Flags 解析

Flags 是一个 16 位的字段，详细解析如下：

`QR | Opcode | AA | TC | RD | RA | Z | AD | CD | RCODE`

| 位 | 含义 | 描述 |
|-----|------|------|
| QR | 查询/响应 | 0 = 查询，1 = 响应 |
| Opcode | 操作码 | 0 = 标准查询，1 = 反向查询，2 = 状态查询 |
| AA | 授权应答 | 是否是权威服务器的应答 |
| TC | 截断标志 | 数据包是否被截断 |
| RD | 期望递归 | 客户端期望服务器递归查询 |
| RA | 支持递归 | 服务器是否支持递归查询 |
| Z | 保留位，未使用 | 必须是 0 |
| AD | 数据已认证 | 安全验证标志 |
| CD | 检查已禁用 | 禁用安全验证 |
| RCODE | 返回码 | 0 = 无错误，3 = 域名不存在 |


## Question 部分

Question 是 DNS 请求的核心内容，描述客户端希望查询的信息。

| 偏移量 | 字节 | 描述 |
|--------|------|------|
| 0x0C | 可变 | QName：查询的域名 |
| 0x-- | 2 | QType：查询类型 |
| 0x-- | 2 | QClass：查询类别 |

### QName

QName 是域名的二进制表示：
* 以标签长度开头，后面是标签的内容，最后一个字节是 0x00 表示结束
* 例如：

```
www.example.com → 03 77 77 77 07 65 78 61 6D 70 6C 65 03 63 6F 6D 00
```



### QType

| 值 | 描述 |
|-----|------|
| 0x0001 | A 记录（IPv4 地址）|
| 0x0002 | NS 记录（域名服务器）|
| 0x0005 | CNAME 记录（别名）|
| 0x000F | MX 记录（邮件交换）|
| 0x001C | AAAA 记录（IPv6 地址）|

### QClass

| 值 | 描述 |
|-----|------|
| 0x0001 | IN (Internet) |
| 0x0003 | CH (Chaos) |
| 0x0004 | HS (Hesiod) |


## Answer 部分

Answer 是服务器返回的解析结果。

| 偏移量 | 字节 | 描述 |
|--------|------|------|
| 0x-- | 可变 | Name：域名 |
| 0x-- | 2 | Type：记录类型 |
| 0x-- | 2 | Class：记录类别 |
| 0x-- | 4 | TTL：缓存生存时间 |
| 0x-- | 2 | Data Length：数据长度 |
| 0x-- | 可变 | Data：实际的数据，例如 IP 地址 |


## 完整通信示例

查询 `www.example.com` 的 A 记录

### C2S 数据包
```
AA AA 01 00 00 01 00 00 00 00 00 00 
03 77 77 77 07 65 78 61 6D 70 6C 65 03 63 6F 6D 00 
00 01 00 01
```

### S2C 数据包
```
AA AA 81 80 00 01 00 01 00 00 00 00 
03 77 77 77 07 65 78 61 6D 70 6C 65 03 63 6F 6D 00 
00 01 00 01 
C0 0C 00 01 00 01 00 00 00 3C 00 04 5D B8 D8 22
(多出来的是 Answer 部分,返回解析结果)
```

### 解析
* Transaction ID: `AAAA`
* Flags: `8180`（标准查询，递归查询，授权应答）
* Answer:
  * Name: `www.example.com`
  * Type: A
  * Class: IN
  * TTL: 60
  * Data: 93.184.216.34（`5D B8 D8 22`）

## 解析器实现要点

1. Header 解析
   * 提取 ID, Flags, Questions 数量
2. Question 解析
   * 提取域名、查询类型、查询类别
3. Answer 解析
   * 提取域名、IP 地址、TTL 等信息
4. Authority 和 Additional
   * 处理域名服务器和附加记录
   * Authority（权威部分） 和 Additional（附加部分） 是 Answer Section 之外的两个可选部分，用来提供更多的域名解析信息。